name: Check for New Okapi Releases

on:
  schedule:
    # Run daily at 6:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  check-releases:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      - name: Get current versions
        id: current
        run: |
          CURRENT=$(ls -1 okapi-releases | sort -V | tail -1)
          echo "latest=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current latest: $CURRENT"

      - name: Check Maven Central for new versions
        id: upstream
        run: |
          # Query Maven Central for okapi-core versions
          VERSIONS=$(curl -s "https://search.maven.org/solrsearch/select?q=g:net.sf.okapi+AND+a:okapi-core&core=gav&rows=50&wt=json" \
            | jq -r '.response.docs[].v' | sort -V)
          
          UPSTREAM_LATEST=$(echo "$VERSIONS" | tail -1)
          echo "upstream_latest=$UPSTREAM_LATEST" >> $GITHUB_OUTPUT
          echo "Upstream latest: $UPSTREAM_LATEST"
          
          # Check if upstream is newer than current
          CURRENT="${{ steps.current.outputs.latest }}"
          if [ -d "okapi-releases/$UPSTREAM_LATEST" ]; then
            echo "new_version=" >> $GITHUB_OUTPUT
            echo "Version $UPSTREAM_LATEST already exists locally"
          else
            # Verify it's actually newer using sort -V
            NEWER=$(echo -e "$CURRENT\n$UPSTREAM_LATEST" | sort -V | tail -1)
            if [ "$NEWER" = "$UPSTREAM_LATEST" ] && [ "$NEWER" != "$CURRENT" ]; then
              echo "new_version=$UPSTREAM_LATEST" >> $GITHUB_OUTPUT
              echo "New version available: $UPSTREAM_LATEST"
            else
              echo "new_version=" >> $GITHUB_OUTPUT
              echo "No new version (upstream: $UPSTREAM_LATEST, current: $CURRENT)"
            fi
          fi

      - name: Add new Okapi release
        if: steps.upstream.outputs.new_version != ''
        env:
          NEW_VERSION: ${{ steps.upstream.outputs.new_version }}
          PREVIOUS_VERSION: ${{ steps.current.outputs.latest }}
        run: |
          echo "Adding Okapi $NEW_VERSION..."
          make add-release V=$NEW_VERSION
          
          # Copy overrides from previous version
          if [ -d "okapi-releases/$PREVIOUS_VERSION/overrides" ]; then
            cp okapi-releases/$PREVIOUS_VERSION/overrides/*.json \
               okapi-releases/$NEW_VERSION/overrides/ 2>/dev/null || true
            echo "Copied overrides from $PREVIOUS_VERSION"
          fi

      - name: Create Pull Request
        if: steps.upstream.outputs.new_version != ''
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: Add Okapi ${{ steps.upstream.outputs.new_version }} support"
          title: "feat: Add Okapi ${{ steps.upstream.outputs.new_version }} support"
          body: |
            A new Okapi Framework version has been released.

            ## Changes
            - Added `okapi-releases/${{ steps.upstream.outputs.new_version }}/` with generated schemas
            - Copied overrides from ${{ steps.current.outputs.latest }}
            - Updated `schema-versions.json`

            ## Checklist
            - [ ] Review generated schemas for any issues
            - [ ] Check if any new filters were added
            - [ ] Verify overrides are still applicable

            ---
            *This PR was automatically created by the nightly release check workflow.*
          branch: okapi-${{ steps.upstream.outputs.new_version }}
          delete-branch: true
