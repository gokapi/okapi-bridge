name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      latest: ${{ steps.get-latest.outputs.latest }}
    steps:
      - uses: actions/checkout@v4
      - id: get-latest
        run: |
          latest=$(ls -1 okapi-releases | sort -V | tail -1)
          echo "latest=$latest" >> $GITHUB_OUTPUT

  build:
    needs: setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Build with latest Okapi (${{ needs.setup.outputs.latest }})
        run: mvn -B package -f okapi-releases/${{ needs.setup.outputs.latest }}/pom.xml

      - name: Run tests
        run: mvn -B test -Dokapi.version=${{ needs.setup.outputs.latest }}

  verify-schemas:
    needs: setup
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java 17 (for schema tools)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Regenerate composite schemas
        run: ./scripts/centralize-schemas.sh regenerate-composites

      - name: Update README matrix
        run: ./scripts/update-readme-matrix.sh

      - name: Verify schemas are up to date
        run: |
          # Ignore generatedAt timestamps which change on every run
          git diff --stat -- schemas/ README.md
          git diff -- schemas/ README.md | grep '^[+-]' | grep -v '^[+-][+-][+-]' | grep -v '"generatedAt"' > /tmp/meaningful-diff.txt || true
          if [[ -s /tmp/meaningful-diff.txt ]]; then
            echo "::error::Composite schemas or README are out of date. Run 'make version-schemas' locally and commit the results."
            cat /tmp/meaningful-diff.txt | head -40
            exit 1
          fi
          echo "âœ“ Schemas and README are up to date"
