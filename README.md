# Okapi Bridge

A Java bridge for [gokapi](https://github.com/gokapi/gokapi) that provides access to [Okapi Framework](https://okapiframework.org/) filters. This enables gokapi to process 40+ document formats through Okapi's proven filter implementations.

## Features

- **40+ Filters**: HTML, XML, XLIFF, OpenXML, Markdown, JSON, YAML, PO, and many more
- **JSON Schemas**: Comprehensive parameter schemas for each filter with validation
- **Multi-version Support**: Builds for 10 Okapi versions (0.38 to 1.47.0)
- **NDJSON Protocol**: Go plugin interface via stdin/stdout
- **Per-version Dependencies**: Each Okapi version has its own discovered filter dependencies

## Installation

Download a release from GitHub or use gokapi's plugin installer:

```bash
kapi plugins install okapi-bridge
```

## Project Structure

```
okapi-bridge/
├── src/main/java/              # Bridge runtime and schema generator
├── okapi-releases/             # Per-version configuration
│   ├── 1.47.0/
│   │   ├── pom.xml            # Version-specific dependencies (auto-generated)
│   │   ├── schemas/           # Generated JSON schemas
│   │   └── overrides/         # Optional UI hints
│   ├── 1.46.0/
│   │   └── ...
│   └── ...
├── scripts/
│   └── generate-version-pom.sh  # Discovers filters for Okapi version
├── schema-versions.json        # Version history tracking
├── pom.xml                     # Root pom (runtime + tests)
└── Makefile                    # Build automation
```

### pom.xml Structure

- **Root `pom.xml`**: Contains core filter dependencies needed for the bridge runtime JAR and tests. Use `-Dokapi.version=X.Y.Z` to switch versions.

- **`okapi-releases/{version}/pom.xml`**: Auto-generated by `scripts/generate-version-pom.sh`. Contains ALL filters available for that specific Okapi version. Used for schema generation to ensure we capture every filter.

### Per-version pom.xml

Each Okapi version under `okapi-releases/` has its own `pom.xml` that contains only the filters available in that version. This is auto-generated by `scripts/generate-version-pom.sh` which queries Maven Central to discover available filters.

For example, `okf_epub` and `okf_subtitles` are only available in Okapi 1.46.0+, so older versions' pom.xml files won't include them.

## Schema Management

Schemas include version metadata (`$version`, `x-schemaVersion`, `x-okapiVersions`) that tracks when each schema changed. For example, `okf_json` is at v3, introduced in Okapi 1.46.0.

### Makefile Targets

```bash
make help              # Show all targets

# Discovery
make list-upstream     # Query Maven Central for available Okapi versions
make list-local        # List local okapi-releases/ directories

# Schema Management
make add-release V=1.48.0   # Create structure for new Okapi version
make regenerate V=1.47.0    # Regenerate schemas for one version
make regenerate-all         # Regenerate all versions
make version-schemas        # Recompute schema versions across all releases

# Dependencies
make generate-pom V=1.47.0  # Generate version-specific pom.xml
make generate-all-poms      # Generate pom.xml for all versions

# Build
make build V=1.47.0    # Build JAR for specific version
```

## Adding a New Okapi Version

1. Check available versions:
   ```bash
   make list-upstream
   ```

2. Add the new version (discovers filters, generates pom.xml and schemas):
   ```bash
   make add-release V=1.48.0
   ```

3. Optionally copy overrides from a previous version:
   ```bash
   cp okapi-releases/1.47.0/overrides/*.json okapi-releases/1.48.0/overrides/
   ```

4. Commit and push:
   ```bash
   git add okapi-releases/1.48.0 schema-versions.json
   git commit -m "feat: Add Okapi 1.48.0 support"
   git push
   ```

5. Create a release (triggers build for all versions):
   ```bash
   git tag v1.6.0
   git push origin v1.6.0
   ```

## CI/CD

The workflows automatically detect Okapi versions from the `okapi-releases/` directory.

### Nightly Release Check

A scheduled workflow runs daily to check Maven Central for new Okapi releases. If a new version is found, it automatically:
1. Discovers available filters and generates `pom.xml`
2. Generates schemas using version-specific dependencies
3. Copies overrides from the previous version
4. Creates a PR for review

You can also trigger this manually from the Actions tab.

### On Push to Main (CI)

- Builds and tests with the latest Okapi version
- No manual configuration needed when adding versions

### On Tag Push (Release)

1. **Setup job** scans `okapi-releases/` to get version list and latest version
2. **Build matrix** compiles a JAR for each Okapi version in parallel
3. **Release job** creates GitHub release with all artifacts
4. **Registry job** updates the gokapi plugin registry

Each Okapi version produces a separate artifact:
- `okapi-bridge-v1.6.0-okapi1.47.0.tar.gz` (latest, installed as `okapi-bridge`)
- `okapi-bridge-v1.6.0-okapi1.46.0.tar.gz` (installed as `okapi-bridge-1.46.0`)
- etc.

## Development

### Prerequisites

- Java 11+
- Maven 3.6+
- jq (for Makefile targets)
- curl (for filter discovery)

### Building

```bash
# Build with version-specific dependencies
mvn package -f okapi-releases/1.47.0/pom.xml

# Build root project (bridge runtime)
mvn package

# Run tests
make test
```

## License

Apache 2.0 (same as Okapi Framework)
